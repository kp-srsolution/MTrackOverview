[HttpGet("requests/paged")]
        public IActionResult GetPagedApprovals(
            int page = 1,
            int pageSize = 10,
            string? sortBy = null,
            string? sortOrder = "asc",
            string? search = null,
            int? requestIdFilter = null,
            string? partIdFilter = null,
            string? partNameFilter = null,
            string? resultFilter = null,
            string? statusFilter = null
        )
        {
            var result = new List<FinalApproval>();
            int totalRecords = 0;

            using (var conn = _database.GetConnection())
            {
                conn.Open();

                // ✅ WHERE conditions
                var whereClauses = new List<string>();

                if (!string.IsNullOrEmpty(search))
                    whereClauses.Add("(PartName LIKE @Search OR PartId LIKE @Search)");

                if (requestIdFilter.HasValue)
                    whereClauses.Add("Id LIKE @RequestIdFilter");

                if (!string.IsNullOrEmpty(partIdFilter))
                    whereClauses.Add("PartId LIKE @PartIdFilter");

                if (!string.IsNullOrEmpty(partNameFilter))
                    whereClauses.Add("PartName LIKE @PartNameFilter");

                if (!string.IsNullOrEmpty(resultFilter))
                    whereClauses.Add("Result LIKE @ResultFilter");

                if (!string.IsNullOrEmpty(statusFilter))
                    whereClauses.Add("Status LIKE @StatusFilter");

                string whereClause = whereClauses.Count > 0
                    ? "WHERE " + string.Join(" AND ", whereClauses)
                    : "";

                // ✅ Sorting with whitelisting
                var allowedSortColumns = new HashSet<string>
                {
                    "Id", "PartId", "partName", "result", "status", "CreatedAt"
                };
                string orderBy = allowedSortColumns.Contains(sortBy ?? "")
                    ? sortBy!
                    : "Id";

                string orderDirection = sortOrder?.ToLower() == "desc" ? "DESC" : "ASC";

                // ✅ Count query
                using (var countCmd = new SqlCommand($"SELECT COUNT(*) FROM ApprovalRequests {whereClause}", conn))
                {
                    if (!string.IsNullOrEmpty(search))
                        countCmd.Parameters.AddWithValue("@Search", $"%{search}%");
                    if (requestIdFilter.HasValue)
                        countCmd.Parameters.AddWithValue("@RequestIdFilter", $"%{requestIdFilter}%");
                    if (!string.IsNullOrEmpty(partNameFilter))
                        countCmd.Parameters.AddWithValue("@PartNameFilter", $"%{partNameFilter}%");
                    if (!string.IsNullOrEmpty(resultFilter))
                        countCmd.Parameters.AddWithValue("@ResultFilter", $"%{resultFilter}%");
                    if (!string.IsNullOrEmpty(partIdFilter))
                        countCmd.Parameters.AddWithValue("@PartIdFilter", $"%{partIdFilter}%");
                    if (!string.IsNullOrEmpty(statusFilter))
                        countCmd.Parameters.AddWithValue("@StatusFilter", $"%{statusFilter}%");

                    totalRecords = Convert.ToInt32(countCmd.ExecuteScalar());
                }

                int offset = (page - 1) * pageSize;

                using (var cmd = new SqlCommand($@"
    SELECT *
    FROM ApprovalRequests
    {whereClause}
    ORDER BY {orderBy} {orderDirection}
    OFFSET @Offset ROWS
    FETCH NEXT @PageSize ROWS ONLY", conn))
                {
                    cmd.Parameters.AddWithValue("@Offset", offset);
                    cmd.Parameters.AddWithValue("@PageSize", pageSize);

                    if (!string.IsNullOrEmpty(search))
                        cmd.Parameters.AddWithValue("@Search", $"%{search}%");

                    if (requestIdFilter.HasValue)
                        cmd.Parameters.AddWithValue("@RequestIdFilter", $"%{requestIdFilter}%");

                    if (!string.IsNullOrEmpty(partNameFilter))
                        cmd.Parameters.AddWithValue("@PartNameFilter", $"%{partNameFilter}%");

                    if (!string.IsNullOrEmpty(resultFilter))
                        cmd.Parameters.AddWithValue("@ResultFilter", $"%{resultFilter}%");

                    if (!string.IsNullOrEmpty(partIdFilter))
                        cmd.Parameters.AddWithValue("@PartIdFilter", $"%{partIdFilter}%");

                    if (!string.IsNullOrEmpty(statusFilter))
                        cmd.Parameters.AddWithValue("@StatusFilter", $"%{statusFilter}%");

                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            result.Add(new FinalApproval
                            {
                                Id = reader.GetInt32(reader.GetOrdinal("Id")),
                                PartName = reader["PartName"].ToString(),
                                PartId = reader["PartId"].ToString(),
                                Status = reader["Status"].ToString(),
                                Result = reader["Result"].ToString(),
                                CreatedAt = (DateTime)reader["CreatedAt"],
                                ActionBySuperVisor = (bool)reader["ActionBySuperVisor"],
                                ActionByManager = (bool)reader["ActionByManager"],
                                ActionBySeniorManager = (bool)reader["ActionBySeniorManager"],
                                SupervisorActionComent = reader["SupervisorActionComent"]?.ToString(),
                                ManagerActionComent = reader["ManagerActionComent"]?.ToString(),
                                SeniorManagerActionComent = reader["SeniorManagerActionComent"]?.ToString()
                            });
                        }
                    }
                }


            }

            var response = new
            {
                data = result.Select(r => new
                {
                    r.Id,
                    r.PartId,
                    r.PartName,
                    r.Status,
                    r.Result,
                    r.CreatedAt,
                    r.ActionBySuperVisor,
                    r.ActionByManager,
                    r.ActionBySeniorManager,
                    r.SupervisorActionComent,
                    r.ManagerActionComent,
                    r.SeniorManagerActionComent,
                    TimeString = r.CreatedAt.ToString("dd-MM-yyyy HH:mm:ss")
                }),
                totalRecords
            };

            return Ok(response);

        }


{
  "data": [
    {
      "id": 1,
      "partId": "p001",
      "partName": "Part",
      "status": "Approved",
      "result": "GOOD",
      "createdAt": "2025-12-25T12:24:16.49",
      "actionBySuperVisor": false,
      "actionByManager": false,
      "actionBySeniorManager": false,
      "supervisorActionComent": "",
      "managerActionComent": "",
      "seniorManagerActionComent": "",
      "timeString": "25-12-2025 12:24:16"
    },
    {
      "id": 3,
      "partId": "PART0002",
      "partName": "Part 2",
      "status": "Approved",
      "result": "GOOD",
      "createdAt": "2025-12-25T17:40:31.3133333",
      "actionBySuperVisor": true,
      "actionByManager": true,
      "actionBySeniorManager": true,
      "supervisorActionComent": "Here we go",
      "managerActionComent": "Here we go",
      "seniorManagerActionComent": "Here",
      "timeString": "25-12-2025 17:40:31"
    },
    {
      "id": 4,
      "partId": "Part0002",
      "partName": "Part 5",
      "status": "Rejected",
      "result": "GOOD",
      "createdAt": "2025-12-25T18:04:19.3533333",
      "actionBySuperVisor": false,
      "actionByManager": false,
      "actionBySeniorManager": false,
      "supervisorActionComent": "Demo Supervisor comment",
      "managerActionComent": "",
      "seniorManagerActionComent": "",
      "timeString": "25-12-2025 18:04:19"
    },
    {
      "id": 5,
      "partId": "PART003",
      "partName": "Part 5",
      "status": "SupervisorApproved",
      "result": "BAD",
      "createdAt": "2025-12-25T18:06:17.3166667",
      "actionBySuperVisor": true,
      "actionByManager": false,
      "actionBySeniorManager": false,
      "supervisorActionComent": "GOOD",
      "managerActionComent": "",
      "seniorManagerActionComent": "",
      "timeString": "25-12-2025 18:06:17"
    },
    {
      "id": 6,
      "partId": "PART001",
      "partName": "Demo Part",
      "status": "Approved",
      "result": "GOOD",
      "createdAt": "2025-12-25T18:12:00.05",
      "actionBySuperVisor": true,
      "actionByManager": true,
      "actionBySeniorManager": true,
      "supervisorActionComent": "Demo comment from Supervisor",
      "managerActionComent": "Demo Comment from Manager",
      "seniorManagerActionComent": "Demo Comment from Senior Manager",
      "timeString": "25-12-2025 18:12:00"
    },
    {
      "id": 7,
      "partId": "PART0007",
      "partName": "Demo Part 2",
      "status": "Rejected",
      "result": "BAD",
      "createdAt": "2025-12-25T18:14:23.73",
      "actionBySuperVisor": false,
      "actionByManager": false,
      "actionBySeniorManager": false,
      "supervisorActionComent": "Demo rejection comment",
      "managerActionComent": "",
      "seniorManagerActionComent": "",
      "timeString": "25-12-2025 18:14:23"
    }
  ],
  "totalRecords": 6
}
